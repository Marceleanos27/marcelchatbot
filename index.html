<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>George ‚Äì Estate Agent Chatbot</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #f4f4f4;
    }

    #chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 360px;
      max-height: 500px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.4s ease;
      z-index: 9999;
      box-sizing: border-box;
    }

    #chatbot-container.closed {
      max-height: 50px;
      width: 220px;
      border-radius: 50px;
    }

    #chatbot-header {
      background: linear-gradient(135deg, #0f7d57, #00b894);
      color: white;
      padding: 14px 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.05em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #toggle-icon {
      font-size: 1.5em;
      transition: transform 0.3s ease;
    }

    #chatbot-container:not(.closed) #toggle-icon {
      transform: rotate(45deg);
    }

    #chatbot-container.closed #chatbot-body {
      display: none;
    }

    #chatbot-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #fafafa;
      height: 450px;
    }

    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 75%;
      font-size: 0.95em;
      line-height: 1.4;
    }

    .message.user {
      align-self: flex-end;
      background: #d1f7ec;
      color: #1a3e2d;
    }

    .message.bot {
      align-self: flex-start;
      background: #eeeeee;
      color: #333;
    }

    #input-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    #user-input {
      width: 100%;
      resize: none;
      height: 60px;
      padding: 10px 12px;
      font-size: 1em;
      border-radius: 10px;
      border: 1.5px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: linear-gradient(to right, #00b894, #0f7d57);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: linear-gradient(to right, #0f7d57, #00b894);
    }
  </style>
</head>
<body>
  <div id="chatbot-container" class="closed">
    <div id="chatbot-header" onclick="toggleChatbot()">üí¨ George AI<span id="toggle-icon">+</span></div>
    <div id="chatbot-body">
      <div id="chat-messages">
        <div class="message bot">
          <strong>George:</strong> Hi! I'm George, your virtual estate agent üè°. Whether you're buying, selling, or renting, I‚Äôm here to help. How can I assist you today?
        </div>
      </div>
      <div id="input-area">
        <textarea id="user-input" placeholder="Ask me anything about real estate..."></textarea>
        <button onclick="sendMessage()">Send Message</button>
      </div>
    </div>
  </div>

  <script>
    let chatHistory = [
      {
        role: "system",
        content: "You are George, a professional and friendly virtual estate agent. You help users with buying, selling, or renting homes and properties. You can answer questions about pricing, neighborhoods, property types, mortgages, and the real estate process. Always respond like a real human agent, never say you are an AI. Keep answers clear, helpful, and professional."
      }
    ];

    const chatbox = document.getElementById("chat-messages");
    const inputField = document.getElementById("user-input");

    function toggleChatbot() {
      const container = document.getElementById("chatbot-container");
      container.classList.toggle("closed");
      const icon = document.getElementById("toggle-icon");
      icon.innerText = container.classList.contains("closed") ? "+" : "‚àí";
    }

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function sendMessage() {
      const message = inputField.value.trim();
      if (!message) return;

      appendMessage("You", message, "user");
      chatHistory.push({ role: "user", content: message });
      inputField.value = "";
      appendMessage("George", "Typing...", "bot", true);

      try {
        await delay(800);

        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ messages: chatHistory })
        });

        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content?.trim() || "I'm not sure how to answer that.";

        chatHistory.push({ role: "assistant", content: reply });
        removeLastBotMessage();
        appendMessage("George", reply, "bot");
      } catch (error) {
        console.error("Error:", error);
        removeLastBotMessage();
        appendMessage("George", `Oops, something went wrong: ${error.message}`, "bot");
      }
    }

    function appendMessage(sender, message, role, isTemp = false) {
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", role);
      if (isTemp) msgDiv.classList.add("temp");
      msgDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
      chatbox.appendChild(msgDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function removeLastBotMessage() {
      const tempMsg = chatbox.querySelector(".bot.temp");
      if (tempMsg) chatbox.removeChild(tempMsg);
    }
  </script>
</body>
</html>
