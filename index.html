   let bookingStep = 0;
let bookingData = {};

async function sendMessage() {
  const message = inputField.value.trim();
  if (!message) return;

  appendMessage("Ty", message, "user");
  inputField.value = "";

  // Ak sme v procese rezerv√°cie, pokraƒçuj v zbieran√≠ d√°t
  if (bookingStep > 0) {
    await handleBookingStep(message);
    return;
  }

  chatHistory.push({ role: "user", content: message });
  appendMessage("George", "P√≠≈°em odpoveƒè...", "bot", true);

  try {
    await delay(800);

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ messages: chatHistory })
    });

    if (!response.ok) {
      throw new Error(`Chyba ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    const reply = data.choices?.[0]?.message?.content?.trim() || "Prep√°ƒç, neviem na to odpoveda≈•.";

    removeLastBotMessage();
    appendMessage("George", reply, "bot");
    chatHistory.push({ role: "assistant", content: reply });

    // Detekuj z√°ujem o rezerv√°ciu v p√¥vodnej spr√°ve alebo odpovedi
    const replyLower = reply.toLowerCase();
    const messageLower = message.toLowerCase();
    const wantsAppointment = messageLower.includes("rezervova≈•") ||
      messageLower.includes("term√≠n") ||
      messageLower.includes("stretnutie") ||
      messageLower.includes("chcem sa objedna≈•") ||
      replyLower.includes("zadaj √∫daje") ||
      replyLower.includes("rezervuj") ||
      replyLower.includes("zarezervova≈•") ||
      replyLower.includes("term√≠n");

    if (wantsAppointment) {
      bookingStep = 1;
      bookingData = {};
      await delay(500);
      appendMessage("George", "üë§ Nap√≠≈° mi svoje meno.", "bot");
    }

  } catch (error) {
    console.error("Chyba:", error);
    removeLastBotMessage();
    appendMessage("George", `Ups, nastala chyba: ${error.message}`, "bot");
  }
}

// Funkcia na postupn√© zbieranie √∫dajov pre rezerv√°ciu
async function handleBookingStep(message) {
  switch (bookingStep) {
    case 1:
      bookingData.name = message;
      bookingStep++;
      appendMessage("George", " üóìÔ∏è Kedy chce≈° rezervova≈• term√≠n? (napr. 2025-08-10)", "bot");
      break;
    case 2:
      bookingData.date = message;
      bookingStep++;
      appendMessage("George",   "üïìO koƒækej hodine? (napr. 14:00)", "bot");
      break;
    case 3:
      bookingData.time = message;
      bookingStep++;
      appendMessage("George", "üíº Ak√∫ slu≈æbu chce≈° rezervova≈•?", "bot");
      break;
    case 4:
      bookingData.service = message;
      bookingStep = 0; // rezerv√°cia ukonƒçen√°
      await sendBookingToWebhook(bookingData);
      bookingData = {};
      break;
  }
}

// Odoslanie √∫dajov do n8n webhooku
async function sendBookingToWebhook(data) {
  try {
    const res = await fetch("https://marcellehocky.app.n8n.cloud/webhook-test/book-appointment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      appendMessage("George", `‚úÖ Tvoj term√≠n bol √∫spe≈°ne rezervovan√Ω na ${data.date} o ${data.time}.`, "bot");
    } else {
      appendMessage("George", "‚ùå Nepodarilo sa rezervova≈• term√≠n. Sk√∫s to pros√≠m znova.", "bot");
    }
  } catch (err) {
    console.error("Chyba pri odosielan√≠ do n8n:", err);
    appendMessage("George", "‚ùå Nastala technick√° chyba. Sk√∫s to nesk√¥r.", "bot");
  }
}


    function appendMessage(sender, message, role, isTemp = false) {
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", role);
      if (isTemp) msgDiv.classList.add("temp");

      // Tu sa spracuje **text** na <strong>text</strong>
      const formattedMessage = message.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      msgDiv.innerHTML = `<strong>${sender}:</strong> ${formattedMessage}`;
      chatbox.appendChild(msgDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function removeLastBotMessage() {
      const tempMsg = chatbox.querySelector(".bot.temp");
      if (tempMsg) chatbox.removeChild(tempMsg);
    }



async function startAppointmentBooking() {
  bookingStep = 1;
  bookingData = {};
  appendMessage("George", "üìù Pros√≠m, nap√≠≈° svoje meno:", "bot");
}

async function handleBookingAnswer(answer) {
  if (bookingStep === 1) {
    bookingData.name = answer;
    bookingStep = 2;
    appendMessage("George", "Na ktor√Ω d√°tum chce≈° rezervova≈• term√≠n? (napr. 2025-08-10)", "bot");
  } else if (bookingStep === 2) {
    bookingData.date = answer;
    bookingStep = 3;
    appendMessage("George", "Na ktor√Ω ƒças? (napr. 14:00)", "bot");
  } else if (bookingStep === 3) {
    bookingData.time = answer;
    bookingStep = 4;
    appendMessage("George", "Ak√∫ slu≈æbu chce≈° rezervova≈•?", "bot");
  } else if (bookingStep === 4) {
    bookingData.service = answer;
    bookingStep = 0; // koniec zbierania

    // Odo≈°li na webhook
    try {
      const res = await fetch("https://marcellehocky.app.n8n.cloud/webhook-test/book-appointment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(bookingData)
      });

      if (res.ok) {
        appendMessage("George", `‚úÖ Tvoj term√≠n bol √∫spe≈°ne rezervovan√Ω na ${bookingData.date} o ${bookingData.time}.`, "bot");
      } else {
        appendMessage("George", "‚ùå Nepodarilo sa rezervova≈• term√≠n. Sk√∫s to pros√≠m znova.", "bot");
      }
    } catch (err) {
      console.error("Chyba pri odosielan√≠ do n8n:", err);
      appendMessage("George", "‚ùå Nastala technick√° chyba. Sk√∫s to nesk√¥r.", "bot");
    }
  }
